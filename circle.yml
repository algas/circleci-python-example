machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  pre:
    - if [[ -e ~/docker/docker.tar ]]; then docker load --input ~/docker/docker.tar; fi

  override:
    - docker build --rm=false -t algas/circleci-python-example .

  post:
    - if [[ ! -d ~/docker ]]; then mkdir -p ~/docker; fi
    - docker save algas/circleci-python-example > ~/docker/docker.tar

test:
  pre:

  override:
    - docker run -d -p 8080:8080 algas/circleci-python-example
    - sleep 10
    - curl --retry 10 --retry-delay 5 -v http://localhost:8080

deployment:
  stage:
    branch: deploy
    commands:
      - ./deploy.sh
